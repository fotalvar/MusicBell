const getAPIUrl=()=>{const protocol=window.location.protocol;const hostname=window.location.hostname;const port=window.location.port;return `${protocol}//${hostname}${port?':'+port:''}/api`};const API_URL=getAPIUrl();const cache={archivos:null,archivosTiempo:0,CACHE_DURACION:30000};let canciones=[];let archivosDisponibles=[];let estadoPanel='abierto';let updateInterval=null;async function fetchAPI(url,options={}){try{const response=await fetch(url,{headers:{'Content-Type':'application/json'},...options});if(!response.ok){throw new Error(`HTTP ${response.status}`)}return await response.json()}catch(error){console.error(`Error en fetch a ${url}:`,error);throw error}}function debounce(func,delay){let timeoutId;return function(...args){clearTimeout(timeoutId);timeoutId=setTimeout(()=>func(...args),delay)}}function formatarTamaño(bytes){if(bytes===0)return'0 B';const k=1024;const sizes=['B','KB','MB','GB'];const i=Math.floor(Math.log(bytes)/Math.log(k));return Math.round(bytes/Math.pow(k,i)*100)/100+' '+sizes[i]}function formatarFecha(fechaIso){if(!fechaIso)return'N/A';const fecha=new Date(fechaIso);return fecha.toLocaleString('es-ES')}function obtenerNombreDia(fecha){const dias=['domingo','lunes','martes','miércoles','jueves','viernes','sábado'];return dias[fecha.getDay()]}document.addEventListener('DOMContentLoaded',function(){console.log('DOM cargado');inicializar()});async function inicializar(){console.log('Inicializando aplicación...');conectarEventos();await cargarArchivos();await cargarCanciones();await cargarEstado();await obtenerDatosRemoto();actualizarSubbarra('canciones');updateInterval=setInterval(async()=>{await cargarEstado()},2000)}function conectarEventos(){document.querySelectorAll('.nav-option').forEach(btn=>{btn.addEventListener('click',function(){const tab=this.dataset.tab;cambiarTab(tab)})});const formularioCancion=document.getElementById('formularioCancion');if(formularioCancion){formularioCancion.addEventListener('submit',agregarCancion)}const formularioProgramacion=document.getElementById('formularioProgramacionRapida');if(formularioProgramacion){formularioProgramacion.addEventListener('submit',generarProgramacionRapida)}const btnConflictos=document.getElementById('btnConflictos');if(btnConflictos){btnConflictos.addEventListener('click',detectarConflictos)}const uploadArea=document.getElementById('uploadArea');if(uploadArea){uploadArea.addEventListener('click',()=>{document.getElementById('fileInput').click()})}const btnAbrirModal=document.getElementById('btnAbrirModalAgregarCancion');if(btnAbrirModal){btnAbrirModal.addEventListener('click',abrirModalAgregarCancion)}const btnProgramacion=document.getElementById('btnAbrirModalProgramacion');if(btnProgramacion){btnProgramacion.addEventListener('click',abrirModalProgramacion)}const fechaInicio=document.getElementById('fechaInicio');const fechaFin=document.getElementById('fechaFin');if(fechaInicio&&fechaFin){fechaInicio.addEventListener('change',actualizarResumenProgramacion);fechaFin.addEventListener('change',actualizarResumenProgramacion);document.getElementById('incluirFinSemana').addEventListener('change',actualizarResumenProgramacion)}}function cambiarTab(tabName){console.log('Cambiando a pestaña:',tabName);document.querySelectorAll('.tab-pane').forEach(tab=>{tab.classList.remove('activo')});const tabElement=document.getElementById(`tab-${tabName}`);if(tabElement){tabElement.classList.add('activo')}document.querySelectorAll('.nav-option').forEach(btn=>{btn.classList.remove('activo')});const activeBtn=document.querySelector(`[data-tab="${tabName}"]`);if(activeBtn){activeBtn.classList.add('activo')}actualizarSubbarra(tabName)}function actualizarSubbarra(tab){const subbarraContent=document.getElementById('subbarraAcciones');let html='';if(tab==='canciones'){html=`
            <button id="btnAbrirModalAgregarCancion" class="btn-agregar">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Añadir Canción
            </button>
            <button id="btnAbrirModalProgramacion" class="btn-programacion-rapida">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.41 1.41C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
                Programación Rápida
            </button>
            <button id="btnAbrirModalCarga" class="btn-agregar">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Cargar Música
            </button>
        `}else if(tab==='reproduccion'){html=`<p style="margin: 0; color: #666; font-size: 0.9em;">Selecciona una canción para reproducir</p>`}else if(tab==='archivado'){html=`<p style="margin: 0; color: #666; font-size: 0.9em;">Canciones marcadas como archivadas</p>`}else if(tab==='conflictos'){html=`<p style="margin: 0; color: #666; font-size: 0.9em;">Verifica los conflictos de horario</p>`}subbarraContent.innerHTML=html;if(tab==='canciones'){document.getElementById('btnAbrirModalAgregarCancion').addEventListener('click',abrirModalAgregarCancion);document.getElementById('btnAbrirModalProgramacion').addEventListener('click',abrirModalProgramacion);document.getElementById('btnAbrirModalCarga').addEventListener('click',abrirModalCargaRemota)}}async function cargarArchivos(){try{const response=await fetchAPI(`${API_URL}/archivos`);archivosDisponibles=response;const selectArchivo=document.getElementById('archivo');if(selectArchivo){selectArchivo.innerHTML='<option value="">-- Selecciona un archivo --</option>';response.forEach(archivo=>{const option=document.createElement('option');option.value=archivo.nombre;option.textContent=`${archivo.nombre} (${formatarTamaño(archivo.tamaño)})`;selectArchivo.appendChild(option)})}}catch(error){console.error('Error cargando archivos:',error)}}async function cargarCanciones(){try{const response=await fetchAPI(`${API_URL}/canciones`);canciones=response;renderizarPlaylist()}catch(error){console.error('Error cargando canciones:',error)}}async function cargarEstado(){try{const response=await fetchAPI(`${API_URL}/estado`);const cancionActual=response.cancion_actual||'Parado';document.getElementById('estadoCancionActual').textContent=cancionActual}catch(error){console.error('Error cargando estado:',error)}}async function obtenerDatosRemoto(){try{const response=await fetchAPI(`${API_URL}/datos-remoto`);document.getElementById('estadoIP').textContent=response.ip||'Desconocida';document.getElementById('estadoPuerto').textContent=response.puerto||'5000';document.getElementById('estadoRemoto').textContent=`${response.ip}:${response.puerto}`||'-'}catch(error){console.error('Error obteniendo datos remoto:',error);document.getElementById('estadoIP').textContent='localhost';document.getElementById('estadoPuerto').textContent='5000'}}function renderizarPlaylist(){const container=document.getElementById('playlistContainer');if(!container)return;const cancionesActivas=canciones.filter(c=>!c.archivado);if(cancionesActivas.length===0){container.innerHTML='<p>No hay canciones en la playlist';return}container.innerHTML=cancionesActivas.map(cancion=>`
        <div class="cancion-card">
            <h4>${cancion.nombre}</h4>
            <p><strong>Archivo:</strong> ${cancion.archivo}</p>
            <p><strong>Tipo:</strong> ${cancion.tipo_planificacion}</p>
            <p><strong>Hora:</strong> ${cancion.hora||'N/A'}</p>
            <p><strong>Duración:</strong> ${cancion.duracion||'N/A'}</p>
            <div class="acciones-cancion">
                <button onclick="editarCancion(${cancion.id})" class="btn-editar">Editar</button>
                <button onclick="archivarCancion(${cancion.id})" class="btn-archivar">Archivar</button>
                <button onclick="eliminarCancion(${cancion.id})" class="btn-eliminar">Eliminar</button>
            </div>
        </div>
    `).join('');agregarEstilosCancionCard()}function renderizarReproduccion(){const container=document.getElementById('reproduccionContainer');if(!container||!archivosDisponibles)return;if(archivosDisponibles.length===0){container.innerHTML='<p>No hay canciones disponibles';return}container.innerHTML=archivosDisponibles.map(archivo=>`
        <div class="cancion-card">
            <h4>${archivo.nombre}</h4>
            <p><strong>Tamaño:</strong> ${formatarTamaño(archivo.tamaño)}</p>
            <button onclick="reproducirCancion('${archivo.nombre}')" class="btn-reproducir">
                ▶ Reproducir
            </button>
        </div>
    `).join('');agregarEstilosCancionCard()}function renderizarArchivadas(){const container=document.getElementById('archivadoContainer');if(!container)return;const cancionesArchivadas=canciones.filter(c=>c.archivado);if(cancionesArchivadas.length===0){container.innerHTML='<p>No hay canciones archivadas';return}container.innerHTML=cancionesArchivadas.map(cancion=>`
        <div class="cancion-card">
            <h4>${cancion.nombre}</h4>
            <p><strong>Archivo:</strong> ${cancion.archivo}</p>
            <p><strong>Archivado:</strong> ${formatarFecha(cancion.fecha_archivo)}</p>
            <button onclick="desarchivarCancion(${cancion.id})" class="btn-editar">Restaurar</button>
        </div>
    `).join('');agregarEstilosCancionCard()}function agregarEstilosCancionCard(){if(!document.getElementById('cancion-card-styles')){const style=document.createElement('style');style.id='cancion-card-styles';style.textContent='.cancion-card{background:var(--white);border:1px solid var(--gray-200);border-radius:8px;padding:15px;display:flex;flex-direction:column;gap:10px;transition:all .3s ease}.cancion-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);border-color:var(--primary)}.cancion-card h4{margin:0;color:var(--primary);font-size:1em;word-break:break-word}.cancion-card p{margin:5px 0;font-size:.85em;color:var(--gray-600)}.acciones-cancion,.cancion-card-actions{display:flex;gap:8px;flex-wrap:wrap}.btn-editar,.btn-archivar,.btn-eliminar,.btn-reproducir{flex:1;padding:8px 12px;border:1px solid var(--gray-300);background:var(--white);border-radius:6px;cursor:pointer;font-size:.85em;transition:all .3s ease;font-weight:500;min-width:70px}.btn-editar{color:var(--info);border-color:var(--info)}.btn-editar:hover{background:var(--info);color:var(--white)}.btn-archivar{color:var(--warning);border-color:var(--warning)}.btn-archivar:hover{background:var(--warning);color:var(--white)}.btn-eliminar{color:var(--danger);border-color:var(--danger)}.btn-eliminar:hover{background:var(--danger);color:var(--white)}.btn-reproducir{color:var(--success);border-color:var(--success);background:#d3f9d8}.btn-reproducir:hover{background:var(--success);color:var(--white)}';document.head.appendChild(style)}}function abrirModalAgregarCancion(){document.getElementById('modalAgregarCancion').classList.add('abierto');cargarArchivos()}function cerrarModalAgregarCancion(){document.getElementById('modalAgregarCancion').classList.remove('abierto');document.getElementById('formularioCancion').reset()}function abrirModalProgramacion(){document.getElementById('modalProgramacionRapida').classList.add('abierto');const hoy=new Date().toISOString().split('T')[0];document.getElementById('fechaInicio').value=hoy}function cerrarModalProgramacion(){document.getElementById('modalProgramacionRapida').classList.remove('abierto');document.getElementById('formularioProgramacionRapida').reset()}function abrirModalCargaRemota(){document.getElementById('modalCargaRemota').classList.add('abierto')}function cerrarModalCargaRemota(){document.getElementById('modalCargaRemota').classList.remove('abierto');document.getElementById('fileInput').value=''}function cambiarTipo(){const tipo=document.getElementById('tipo').value;document.getElementById('grupoFecha').style.display=tipo==='fecha'?'block':'none';document.getElementById('grupoDias').style.display=tipo==='dia_semana'?'block':'none'}async function agregarCancion(e){e.preventDefault();const nombre=document.getElementById('nombre').value;const archivo=document.getElementById('archivo').value;const tipo=document.getElementById('tipo').value;const hora=document.getElementById('hora').value;const fecha=document.getElementById('fecha').value;const dias=[];document.querySelectorAll('input[name="dia"]:checked').forEach(checkbox=>{dias.push(checkbox.value)});const data={nombre,archivo,tipo_planificacion:tipo,hora,fecha:fecha||undefined,dias:dias.length>0?dias:undefined,habilitada:true};try{const response=await fetchAPI(`${API_URL}/canciones`,{method:'POST',body:JSON.stringify(data)});alert('¡Canción añadida exitosamente!');cerrarModalAgregarCancion();await cargarCanciones()}catch(error){alert('Error al añadir canción: '+error.message)}}async function reproducirCancion(nombreArchivo){try{const response=await fetchAPI(`${API_URL}/reproducir/${nombreArchivo}`,{method:'POST'});alert('Reproduciendo: '+nombreArchivo);await cargarEstado()}catch(error){alert('Error reproduciendo: '+error.message)}}async function detenerCancion(){try{await fetchAPI(`${API_URL}/detener`,{method:'POST'});alert('Reproducción detenida');await cargarEstado()}catch(error){alert('Error deteniendo: '+error.message)}}async function eliminarCancion(id){if(!confirm('¿Estás seguro de que quieres eliminar esta canción?'))return;try{await fetchAPI(`${API_URL}/canciones/${id}`,{method:'DELETE'});await cargarCanciones()}catch(error){alert('Error eliminando canción: '+error.message)}}async function archivarCancion(id){try{const cancion=canciones.find(c=>c.id===id);if(!cancion)return;await fetchAPI(`${API_URL}/canciones/${id}`,{method:'PUT',body:JSON.stringify({archivado:true,fecha_archivo:new Date().toISOString()})});await cargarCanciones()}catch(error){alert('Error archivando canción: '+error.message)}}async function desarchivarCancion(id){try{await fetchAPI(`${API_URL}/canciones/${id}`,{method:'PUT',body:JSON.stringify({archivado:false})});await cargarCanciones()}catch(error){alert('Error desarchivando canción: '+error.message)}}function actualizarResumenProgramacion(){const fechaInicio=new Date(document.getElementById('fechaInicio').value);const fechaFin=new Date(document.getElementById('fechaFin').value);const incluirFinSemana=document.getElementById('incluirFinSemana').checked;if(!fechaInicio||!fechaFin||fechaInicio>fechaFin){document.getElementById('resumenProgramacion').textContent='Fechas inválidas';return}let count=0;const currentDate=new Date(fechaInicio);while(currentDate<=fechaFin){const dayOfWeek=currentDate.getDay();if(incluirFinSemana||dayOfWeek!==0&&dayOfWeek!==6){count++}currentDate.setDate(currentDate.getDate()+1)}document.getElementById('resumenProgramacion').textContent=`Se programarán ${count} día(s) desde ${fechaInicio.toLocaleDateString('es-ES')} hasta ${fechaFin.toLocaleDateString('es-ES')}`}async function generarProgramacionRapida(e){e.preventDefault();const archivo=document.getElementById('archivo').value;const nombre=document.getElementById('nombre').value;if(!archivo||!nombre){alert('Por favor completa el formulario principal primero');return}const fechaInicio=new Date(document.getElementById('fechaInicio').value);const fechaFin=new Date(document.getElementById('fechaFin').value);const horaRapida=document.getElementById('horaRapida').value;const incluirFinSemana=document.getElementById('incluirFinSemana').checked;const currentDate=new Date(fechaInicio);let cancionesCreadas=0;while(currentDate<=fechaFin){const dayOfWeek=currentDate.getDay();if(incluirFinSemana||dayOfWeek!==0&&dayOfWeek!==6){const data={nombre:`${nombre} - ${currentDate.toLocaleDateString('es-ES')}`,archivo,tipo_planificacion:'fecha',hora:horaRapida,fecha:currentDate.toISOString().split('T')[0],habilitada:true};try{await fetchAPI(`${API_URL}/canciones`,{method:'POST',body:JSON.stringify(data)});cancionesCreadas++}catch(error){console.error('Error creando canción:',error)}}currentDate.setDate(currentDate.getDate()+1)}alert(`¡${cancionesCreadas} canciones programadas exitosamente!`);cerrarModalProgramacion();await cargarCanciones()}async function detectarConflictos(){try{const response=await fetchAPI(`${API_URL}/detectar-conflictos`);const conflictosContent=document.getElementById('conflictosContent');if(!response.conflictos||Object.keys(response.conflictos).length===0){conflictosContent.innerHTML='<p style="color: green; font-weight: bold;">✓ No hay conflictos detectados</p>';return}let html='<p style="color: red; font-weight: bold;">⚠ Se detectaron conflictos:</p>';html+='<div style="display: grid; gap: 10px;">';for(const[horario,cancionesConflicto]of Object.entries(response.conflictos)){html+=`
                <div style="background: #ffe8e8; padding: 15px; border-radius: 8px; border-left: 4px solid red;">
                    <strong>${horario}</strong>
                    <ul>
                        ${cancionesConflicto.map(c=>`<li>${c}</li>`).join('')}
                    </ul>
                </div>
            `}html+='</div>';conflictosContent.innerHTML=html}catch(error){alert('Error detectando conflictos: '+error.message)}}function minimizarPanel(){const panel=document.getElementById('panelEstado');if(estadoPanel==='abierto'){panel.classList.add('minimizado');estadoPanel='minimizado'}else{panel.classList.remove('minimizado');estadoPanel='abierto'}}function copiarDatosRemoto(){const ip=document.getElementById('estadoIP').textContent;const puerto=document.getElementById('estadoPuerto').textContent;const datos=`${ip}:${puerto}`;navigator.clipboard.writeText(datos).then(()=>{alert('Datos copiados: '+datos)}).catch(err=>{alert('Error al copiar: '+err)})}function handleDragOver(e){e.preventDefault();document.getElementById('uploadArea').classList.add('dragover')}function handleDragLeave(e){e.preventDefault();document.getElementById('uploadArea').classList.remove('dragover')}function handleDrop(e){e.preventDefault();document.getElementById('uploadArea').classList.remove('dragover');const files=e.dataTransfer.files;handleFileSelect({target:{files}})}function handleFileSelect(e){const files=e.target.files;uploadarArchivos(files)}async function uploadarArchivos(files){if(files.length===0)return;for(let file of files){if(!file.name.toLowerCase().endsWith('.mp3')){alert('Solo se permiten archivos MP3');return}}document.getElementById('uploadProgress').style.display='block';let uploadedCount=0;for(let file of files){try{const formData=new FormData();formData.append('file',file);const response=await fetch(`${API_URL}/cargar-archivo`,{method:'POST',body:formData});if(response.ok){uploadedCount++;const progress=uploadedCount/files.length*100;document.getElementById('progressFill').style.width=progress+'%';document.getElementById('uploadStatus').textContent=`Subidos ${uploadedCount} de ${files.length} archivos...`}}catch(error){console.error('Error subiendo archivo:',error)}}document.getElementById('uploadProgress').style.display='none';alert(`¡${uploadedCount} archivo(s) subido(s) exitosamente!`);await cargarArchivos();cerrarModalCargaRemota()}async function apagarAplicacion(){if(!confirm('¿Estás seguro de que quieres apagar la aplicación?'))return;try{await fetchAPI(`${API_URL}/apagar`,{method:'POST'})}catch(error){console.error('Error apagando:',error)}}document.addEventListener('visibilitychange',async()=>{if(!document.hidden){await cargarCanciones();await cargarEstado()}});const observer=new MutationObserver(async mutations=>{mutations.forEach(mutation=>{if(mutation.attributeName==='class'){const tabPanes=document.querySelectorAll('.tab-pane');tabPanes.forEach(pane=>{if(pane.classList.contains('activo')){const tabId=pane.id;if(tabId==='tab-canciones'){renderizarPlaylist()}else if(tabId==='tab-reproduccion'){renderizarReproduccion()}else if(tabId==='tab-archivado'){renderizarArchivadas()}}})}})});document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('.tab-pane').forEach(pane=>{observer.observe(pane,{attributes:true})})});
